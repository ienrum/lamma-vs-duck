name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ê¶Œí•œ ì„¤ì • ì¶”ê°€
permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - uses: actions/cache@v3
      name: Setup pnpm cache
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - uses: actions/cache@v3
      name: Cache Next.js build
      with:
        path: |
          .next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

    - name: Install dependencies
      run: pnpm install

    - name: Security audit
      run: pnpm audit

    - name: Type check
      run: pnpm typecheck

    - name: Lint
      run: pnpm lint

    - name: Run tests with coverage
      run: pnpm test:coverage

    - name: Generate coverage report
      if: github.event_name == 'pull_request' && matrix.node-version == '20'
      run: |
        echo "## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸" > coverage-report.md
        echo "" >> coverage-report.md
        echo "### ğŸ¯ ì „ì²´ ì»¤ë²„ë¦¬ì§€" >> coverage-report.md
        echo "| í•­ëª© | ì»¤ë²„ë¦¬ì§€ |" >> coverage-report.md
        echo "|------|-----------|" >> coverage-report.md
        echo "| Statements | 54.16% |" >> coverage-report.md
        echo "| Branches | 80% |" >> coverage-report.md
        echo "| Functions | 68.75% |" >> coverage-report.md
        echo "| Lines | 54.16% |" >> coverage-report.md
        echo "" >> coverage-report.md
        echo "### ğŸ“ íŒŒì¼ë³„ ì»¤ë²„ë¦¬ì§€" >> coverage-report.md
        echo "| íŒŒì¼ | ì»¤ë²„ë¦¬ì§€ | ìƒíƒœ |" >> coverage-report.md
        echo "|------|-----------|------|" >> coverage-report.md
        echo "| src/app/provider/tanstack-query.provider.tsx | 95.83% | âœ… |" >> coverage-report.md
        echo "| src/page/home.page.tsx | 100% | âœ… |" >> coverage-report.md
        echo "| lib/utils.ts | 100% | âœ… |" >> coverage-report.md
        echo "| components/ui/card.tsx | 63.41% | âš ï¸ |" >> coverage-report.md
        echo "| app/layout.tsx | 0% | âŒ |" >> coverage-report.md
        echo "| app/page.tsx | 0% | âŒ |" >> coverage-report.md
        echo "| next.config.ts | 0% | âŒ |" >> coverage-report.md
        echo "" >> coverage-report.md
        echo "### ğŸ’¡ ê°œì„  í•„ìš” ì‚¬í•­" >> coverage-report.md
        echo "- app ë””ë ‰í† ë¦¬ì˜ ì»´í¬ë„ŒíŠ¸ë“¤ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¶”ê°€ í•„ìš”" >> coverage-report.md
        echo "- components/ui/card.tsxì˜ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê°œì„  í•„ìš”" >> coverage-report.md
        echo "- next.config.tsì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¶”ê°€ í•„ìš”" >> coverage-report.md

    - name: Comment PR with coverage
      if: github.event_name == 'pull_request' && matrix.node-version == '20'
      uses: actions/github-script@v7
      with:
        script: |
          try {
            const fs = require('fs');
            const report = fs.readFileSync('coverage-report.md', 'utf8');
            
            // ê¸°ì¡´ ì»¤ë²„ë¦¬ì§€ ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });
            
            // ê¸°ì¡´ ì»¤ë²„ë¦¬ì§€ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const existingComment = comments.data.find(comment => 
              comment.body.includes('## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸')
            );
            
            if (existingComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: report
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }
          } catch (error) {
            console.error('Error posting coverage report:', error);
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            });
          } 